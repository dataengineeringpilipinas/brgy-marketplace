{% extends "base.html" %}

{% block title %}Businesses - Barangay Home-based Business Marketplace{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-white border-2 border-black rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-hand font-bold text-black mb-4">
            <i class="fas fa-store mr-2 text-black"></i>
            Browse Businesses
        </h1>
        
        <!-- Search and Filters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="md:col-span-2">
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search businesses..."
                    class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base font-sans"
                >
            </div>
            <div>
                <select 
                    id="categoryFilter"
                    class="w-full px-4 py-3 border-2 border-black rounded-lg focus:ring-2 focus:ring-black focus:border-transparent text-base font-sans"
                >
                    <option value="">All Categories</option>
                    <option value="Food">Food</option>
                    <option value="Services">Services</option>
                    <option value="Repairs">Repairs</option>
                    <option value="Rentals">Rentals</option>
                    <option value="Crafts">Crafts</option>
                    <option value="Beauty">Beauty</option>
                </select>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2">
            <label class="flex items-center">
                <input 
                    type="checkbox" 
                    id="verifiedFilter"
                    class="rounded border-2 border-black text-black focus:ring-black mr-2"
                >
                <span class="text-sm text-black font-hand">Verified Only</span>
            </label>
        </div>
    </div>

    <!-- Business List -->
    <div id="businessList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Businesses will be loaded here -->
        <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black"></div>
            <p class="mt-2 text-black font-hand">Loading businesses...</p>
        </div>
    </div>
</div>

<script>
// Get URL parameters
const urlParams = new URLSearchParams(window.location.search);
const categoryParam = urlParams.get('category');
const searchParam = urlParams.get('search');

// Set initial filter values
if (categoryParam) {
    document.getElementById('categoryFilter').value = categoryParam;
}
if (searchParam) {
    document.getElementById('searchInput').value = searchParam;
}

// Load businesses
async function loadBusinesses() {
    const category = document.getElementById('categoryFilter').value;
    const search = document.getElementById('searchInput').value;
    const verified = document.getElementById('verifiedFilter').checked;
    
    let url = '/api/businesses?';
    const params = [];
    if (category) params.push(`category=${encodeURIComponent(category)}`);
    if (search) params.push(`search=${encodeURIComponent(search)}`);
    if (verified) params.push('verified=true');
    url += params.join('&');
    
    try {
        const response = await fetch(url);
        const businesses = await response.json();
        
        const container = document.getElementById('businessList');
        if (businesses.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-store text-4xl text-black mb-4"></i>
                    <h3 class="text-lg font-medium text-black mb-2 font-hand">No businesses found</h3>
                    <p class="text-black font-sans">Try adjusting your search or filters</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = businesses.map(business => {
            // Category icons mapping
            const categoryIcons = {
                'Food': 'fa-utensils',
                'Services': 'fa-concierge-bell',
                'Repairs': 'fa-tools',
                'Rentals': 'fa-key',
                'Crafts': 'fa-palette',
                'Beauty': 'fa-spa'
            };
            
            const iconClass = categoryIcons[business.category] || 'fa-store';
            const primaryPhoto = business.photos && business.photos.length > 0 
                ? business.photos.find(p => p.is_primary) || business.photos[0]
                : null;
            
            return `
                <div class="bg-white border-2 border-black rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-200">
                    ${primaryPhoto && !primaryPhoto.image_url.includes('placeholder') ? `
                        <img src="${primaryPhoto.image_url}" alt="${business.name}" class="w-full h-48 object-cover rounded-lg mb-4 border-2 border-black">
                    ` : `
                        <div class="w-full h-48 bg-black rounded-lg mb-4 border-2 border-black flex items-center justify-center">
                            <i class="fas ${iconClass} text-6xl text-white"></i>
                        </div>
                    `}
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-hand font-bold text-black">${business.name}</h3>
                        ${business.is_verified ? `
                            <span class="px-2 py-1 bg-black text-white text-xs rounded-full font-sans">
                                <i class="fas fa-check-circle mr-1"></i>Verified
                            </span>
                        ` : ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-2 font-sans">
                        <i class="fas fa-tag mr-1"></i>${business.category}
                    </p>
                    ${business.location_zone ? `
                        <p class="text-sm text-gray-600 mb-2 font-sans">
                            <i class="fas fa-map-marker-alt mr-1"></i>${business.location_zone}
                        </p>
                    ` : ''}
                    ${business.description ? `
                        <p class="text-sm text-gray-600 mb-4 font-sans line-clamp-2">${business.description}</p>
                    ` : ''}
                    <a href="/businesses/${business.id}" class="block w-full bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 text-center font-hand font-bold">
                        View Details
                    </a>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Error loading businesses:', error);
        document.getElementById('businessList').innerHTML = `
            <div class="col-span-full text-center py-12">
                <p class="text-red-600 font-sans">Error loading businesses. Please try again.</p>
            </div>
        `;
    }
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', (e) => {
    clearTimeout(window.searchTimeout);
    window.searchTimeout = setTimeout(loadBusinesses, 500);
});

document.getElementById('categoryFilter').addEventListener('change', loadBusinesses);
document.getElementById('verifiedFilter').addEventListener('change', loadBusinesses);

// Initial load
loadBusinesses();
</script>
{% endblock %}

